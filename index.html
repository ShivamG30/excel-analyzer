<!DOCTYPE html>
<html>
<head>
    <title>Excel File Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            text-align: center;
            background-color: #f4f4f4;
        }
        h2, h3 {
            color: #333;
        }
        .container {
            background: #fff;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            display: inline-block;
            margin-top: 20px;
        }
        input, button {
            padding: 10px;
            margin: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background-color: #28a745;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background-color: #218838;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        th {
            background-color: #007bff;
            color: white;
        }
        .hidden {
            display: none;
        }
    </style>
    <script>
        function checkAccess() {
            let password = prompt("Enter password to access:");
            if (password !== "mysecurepassword") {
                alert("Access Denied!");
                document.body.innerHTML = ""; // Block access
            }
        }
        window.onload = checkAccess;
    </script>
</head>
<body>
    <div class="container">
        <h2>Excel File Analyzer</h2>
        <input type="file" id="fileInput" />
        <button onclick="processFile()">Analyze</button>
        <h3>Results:</h3>
        <div id="output"></div>
        <h3>Total Rows Displayed: <span id="rowCount">0</span></h3>
        <button id="loadMore" class="hidden" onclick="loadMoreRows()">Load More</button>
    </div>
    <script>
        let fullData = [];
        let currentRow = 0;
        const rowsPerLoad = 500;
        let tableHeaders = [];

        function processFile() {
            let fileInput = document.getElementById('fileInput').files[0];
            if (!fileInput) {
                alert("Please upload a file first.");
                return;
            }
            
            let reader = new FileReader();
            reader.onload = function (e) {
                let data = new Uint8Array(e.target.result);
                let workbook = XLSX.read(data, { type: 'array' });
                let sheet = workbook.Sheets[workbook.SheetNames[0]];
                
                let jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, range: 5 });
                
                if (jsonData.length < 2) {
                    alert("No data found in the sheet.");
                    return;
                }
                
                let headers = jsonData[0].map(h => h.trim().toLowerCase());
                let dataRows = jsonData.slice(1);
                
                let requiredColumns = {
                    'scrip name': 'Scrip Name',
                    'bought code': 'Bought Code',
                    'bought name': 'Bought Name',
                    'bought quantity': 'Bought Quantity',
                    'sold code': 'Sold Code',
                    'sold name': 'Sold Name',
                    'sold quantity': 'Sold Quantity'
                };
                
                let columnIndices = {};
                headers.forEach((col, index) => {
                    if (requiredColumns[col]) {
                        columnIndices[col] = index;
                    }
                });
                
                if (Object.keys(columnIndices).length === 0) {
                    alert("No matching columns found. Please check the column names in your file.");
                    return;
                }
                
                tableHeaders = ['Scrip Name', 'Code', 'Name', 'Quantity'];
                let dataMap = new Map();

                dataRows.forEach(row => {
                    let boughtCode = row[columnIndices['bought code']] || "";
                    let soldCode = row[columnIndices['sold code']] || "";
                    let boughtQuantity = row[columnIndices['bought quantity']] || 0;
                    let soldQuantity = row[columnIndices['sold quantity']] || 0;
                    let key = "";
                    let quantity = 0;
                    
                    if (boughtCode === 'SYS18' || boughtCode === 'SYS27') {
                        key = (row[columnIndices['scrip name']] || "") + "|" + (row[columnIndices['sold name']] || "");
                        quantity = -Math.abs(soldQuantity);
                    } else if (soldCode === 'SYS18' || soldCode === 'SYS27') {
                        key = (row[columnIndices['scrip name']] || "") + "|" + (row[columnIndices['bought name']] || "");
                        quantity = Math.abs(boughtQuantity);
                    }
                    
                    if (key) {
                        if (dataMap.has(key)) {
                            dataMap.set(key, dataMap.get(key) + quantity);
                        } else {
                            dataMap.set(key, quantity);
                        }
                    }
                });

                fullData = Array.from(dataMap.entries())
                    .map(([key, quantity]) => {
                        let [scripName, name] = key.split("|");
                        return { 'Scrip Name': scripName, 'Code': '', 'Name': name, 'Quantity': quantity };
                    })
                    .filter(row => row.Quantity > 5000 || row.Quantity < -5000);
                
                document.getElementById("rowCount").innerText = fullData.length;
                
                currentRow = 0;
                document.getElementById("loadMore").classList.remove("hidden");
                loadMoreRows();
            };
            
            reader.readAsArrayBuffer(fileInput);
        }

        function loadMoreRows() {
            let tableHtml = "<table><tr>" +
                tableHeaders.map(col => `<th>${col}</th>`).join('') + "</tr>";
            
            let rowsToShow = fullData.slice(currentRow, currentRow + rowsPerLoad);
            tableHtml += rowsToShow.map(row => "<tr>" + Object.values(row).map(val => `<td>${val}</td>`).join('') + "</tr>").join('');
            
            document.getElementById("output").innerHTML = tableHtml;
            
            currentRow += rowsPerLoad;
            if (currentRow >= fullData.length) {
                document.getElementById("loadMore").classList.add("hidden");
            }
        }
    </script>
</body>
</html>
