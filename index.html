<!DOCTYPE html>
<//html>
<head>
  <meta charset="UTF-8" />
  <title>Excel File Analyzer</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/js/jquery.dataTables.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.21/css/jquery.dataTables.min.css">

  <style>
    body { font-family: Arial, sans-serif; text-align: center; background-color: #f4f4f4; }
    .container { background: #fff; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); display: inline-block; margin-top: 20px; max-width: 1100px; }
    input, button { padding: 10px; margin: 10px; border: 1px solid #ccc; border-radius: 5px; font-size: 16px; }
    button { background-color: #28a745; color: white; cursor: pointer; }
    button:hover { background-color: #218838; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
    th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
    th { background-color: #007bff; color: white; cursor: pointer; }
    #downloadButton { display: none; }
  </style>

  <script>
    // Optional password gate
    function checkAccess() {
      var password = prompt("Enter password to access:");
      if (password !== "mysecurepassword") {
        alert("Access Denied!");
        document.body.innerHTML = "";
      }
    }
    window.onload = checkAccess;

    // Send analyzed rows to Google Sheets
    async function sendToGoogleSheet(rows) {
      const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbz-IjaF-_2Xn9zV3_pQ3JGMK1v2fWqM_jueyV2p95Us_NzUlpCP7CJShPplmGdrxQC7oA/exec";
      const APP_KEY = "sg_excel_analyzer_9c2e1b6e4f0f4c1ab2a3";

      const body = JSON.stringify({
        appKey: APP_KEY,
        rows,
        ts: new Date().toISOString(),
        ua: navigator.userAgent,
        source: "excel-analyzer"
      });

      try {
        const res = await fetch(WEB_APP_URL, {
          method: "POST",
          headers: { "Content-Type": "text/plain;charset=utf-8" },
          body
        });
        const json = await res.json().catch(() => ({}));
        if (json && json.status === "ok") {
          alert(`Saved ${json.appended || 0} row(s) to Google Sheet.`);
        } else {
          alert(`Save failed (server reply): ${JSON.stringify(json)}`);
        }
      } catch {
        try {
          await fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors",
            headers: { "Content-Type": "text/plain;charset=utf-8" },
            body
          });
          alert("Sent. Please check your Google Sheet for new rows.");
        } catch (err2) {
          alert("Save failed: " + err2.message);
        }
      }
    }
  </script>
</head>
<body>
  <div class="container">
    <h2>Excel File Analyzer</h2>

    <input type="file" id="fileInput" />
    <button onclick="processFile()">Analyze</button>
    <input type="text" id="searchInput" placeholder="Search..." onkeyup="filterTable()">
    <button id="downloadButton" onclick="downloadExcel()">Download as Excel</button>

    <h3>Results:</h3>
    <table id="resultTable" class="display">
      <thead>
        <tr>
          <th>Scrip Name</th>
          <th>Code</th>
          <th>Name</th>
          <th>Quantity</th>
          <th>Mkt. Value</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>Total Rows Displayed: <span id="rowCount">0</span></h3>
  </div>

  <script>
    let fullData = [];
    let dataTableInstance = null;

    function processFile() {
      const file = document.getElementById('fileInput').files[0];
      if (!file) { alert("Please upload a file first."); return; }

      const reader = new FileReader();
      reader.onload = function (e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const sheet = workbook.Sheets[workbook.SheetNames[0]];

        // Read from row 6 (0-indexed range start = 5)
        const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1, range: 5 });
        if (jsonData.length < 2) { alert("No data found in the sheet."); return; }

        const headers = jsonData[0].map(h => String(h || "").trim().toLowerCase());
        const rows = jsonData.slice(1);

        const idx = {
          'scrip name': headers.indexOf('scrip name'),
          'bought code': headers.indexOf('bought code'),
          'bought name': headers.indexOf('bought name'),
          'bought quantity': headers.indexOf('bought quantity'),
          'sold code': headers.indexOf('sold code'),
          'sold name': headers.indexOf('sold name'),
          'sold quantity': headers.indexOf('sold quantity'),
          'ae code': headers.indexOf('ae code')
        };

        // Mkt. Value is the 31st column in the raw sheet (1-indexed) → index 30
        const RAW_MKT_VALUE_COL_INDEX = 30;

        const tempData = {};

        rows.forEach(row => {
          let entry = null;

          const scripName = row[idx['scrip name']];
          const boughtCode = row[idx['bought code']];
          const boughtName = row[idx['bought name']];
          const boughtQty  = Number(row[idx['bought quantity']]);
          const soldCode   = row[idx['sold code']];
          const soldName   = row[idx['sold name']];
          const soldQty    = Number(row[idx['sold quantity']]);
          const aeCode     = idx['ae code'] >= 0 ? row[idx['ae code']] : undefined;

          // Read Mkt. Value (raw 31st column)
          let rawMktVal = Number(row[RAW_MKT_VALUE_COL_INDEX]) || 0;

          // BUSINESS RULES:
          if (boughtCode === 'SYS18' || boughtCode === 'SYS27' || aeCode === 'SYS18' || aeCode === 'SYS27') {
            entry = {
              'Scrip Name': scripName,
              'Code': soldCode,
              'Name': soldName,
              'Quantity': -Math.abs(soldQty),
              'Mkt. Value': rawMktVal
            };
          } else if (soldCode === 'SYS18' || soldCode === 'SYS27') {
            entry = {
              'Scrip Name': scripName,
              'Code': boughtCode,
              'Name': boughtName,
              'Quantity': Math.abs(boughtQty),
              'Mkt. Value': rawMktVal
            };
          }

          if (entry) {
            const key = `${entry['Scrip Name']}|${entry['Name']}`;
            if (tempData[key]) {
              tempData[key]['Quantity']   += entry['Quantity'];
              tempData[key]['Mkt. Value'] += entry['Mkt. Value'];
            } else {
              tempData[key] = entry;
            }
          }
        });

        // FILTER: Mkt. Value > 999,999 and Quantity ≠ 0
        fullData = Object.values(tempData).filter(r =>
          (r['Mkt. Value'] > 999999) && (r['Quantity'] !== 0)
        );

        document.getElementById("rowCount").innerText = fullData.length;
        displayTable(fullData);
        document.getElementById("downloadButton").style.display = 'inline-block';

        if (fullData.length) {
          sendToGoogleSheet(fullData);
        } else {
          alert("No rows met the filter (Mkt. Value > 999,999 and Quantity ≠ 0). Nothing sent.");
        }
      };

      reader.readAsArrayBuffer(file);
    }

    function displayTable(data) {
      const tbody = document.querySelector("#resultTable tbody");
      tbody.innerHTML = "";
      data.forEach(row => {
        const tr = `<tr>
            <td>${row['Scrip Name'] ?? ''}</td>
            <td>${row['Code'] ?? ''}</td>
            <td>${row['Name'] ?? ''}</td>
            <td>${row['Quantity'] ?? ''}</td>
            <td>${row['Mkt. Value'] ?? ''}</td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', tr);
      });

      if (dataTableInstance) dataTableInstance.destroy();
      dataTableInstance = $('#resultTable').DataTable();
    }

    function downloadExcel() {
      const ws = XLSX.utils.json_to_sheet(fullData);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Results");
      XLSX.writeFile(wb, "Analyzed_Data.xlsx");
    }

    function filterTable() {
      const query = document.getElementById('searchInput').value;
      if (dataTableInstance) dataTableInstance.search(query).draw();
    }
  </script>
</body>
</html>

